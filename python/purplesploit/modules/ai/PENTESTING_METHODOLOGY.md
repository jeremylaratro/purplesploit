# PurpleSploit Pentesting Methodology

## Overview

This methodology is derived from analysis of HackTheBox writeups and designed for MCP-server automation integration. It provides structured attack pathways that can be automated via PurpleSploit modules.

---

## Attack Pathway Analysis from HTB Writeups

### Machines Analyzed
- Active, Forest, Backdoor, Armageddon, Bastion, Timelapse
- Intelligence, Support, Horizontall, Previse, Trick
- Writer, Knife, Cap, Bolt

### Common Attack Patterns Identified

| Pattern | Frequency | Examples |
|---------|-----------|----------|
| SMB Enumeration/Anonymous Access | High | Active, Bastion, Timelapse, Support |
| Kerberoasting/AS-REP Roasting | High | Active, Forest, Intelligence |
| Web Application Exploitation | High | Armageddon, Backdoor, Horizontall, Writer |
| Directory Traversal/LFI | Medium | Backdoor, Trick |
| SQL Injection | Medium | Writer, Previse |
| Credential Reuse/Password Cracking | High | All machines |
| Privilege Escalation via SUID/Capabilities | Medium | Cap, Backdoor, Knife |
| Sudo Misconfiguration | Medium | Armageddon, Previse, Knife |

---

## Phase 1: Reconnaissance

### 1.1 Network Discovery
```
MODULES: recon/nmap, recon/nmap_fast, recon/nmap_comprehensive
TOOLS: nmap, rustscan
```

**Automation Steps:**
1. Fast port scan (top 1000 ports)
2. Full port scan (-p-)
3. Service version detection (-sV)
4. Script scanning (-sC)
5. UDP scan on common ports

**Decision Points:**
- If ports 445/139 open → Branch to SMB enumeration
- If ports 88/389/636 open → Branch to AD enumeration
- If ports 80/443/8080 open → Branch to Web enumeration
- If port 21 open → Branch to FTP enumeration
- If port 22 open → Note for later credential testing

### 1.2 Service Enumeration Priority
```python
SERVICE_PRIORITY = {
    "smb": 1,      # Often allows anonymous access
    "ldap": 1,     # AD enumeration without creds
    "dns": 2,      # Zone transfers
    "http": 2,     # Web app vulnerabilities
    "ftp": 3,      # Anonymous access
    "ssh": 4,      # Credential testing
    "rdp": 4,      # Credential testing
    "winrm": 4,    # Credential testing
}
```

---

## Phase 2: SMB/AD Enumeration

### 2.1 Anonymous SMB Enumeration
```
MODULES: smb/enumeration, smb/shares, network/nxc_smb
TOOLS: nxc, smbclient, enum4linux-ng
```

**Automation Steps:**
1. List shares with null session
2. Spider readable shares
3. Download GPP/Groups.xml files
4. Extract domain info

**Key Files to Look For:**
```python
SENSITIVE_FILES = [
    "Groups.xml",           # GPP passwords (Active)
    "*.xml",               # Config files
    "*.config",            # Web configs
    "*.vhd",               # VHD backups (Bastion)
    "*.pfx",               # Certificates (Timelapse)
    "*.zip",               # Archives
    "SYSVOL/**",           # Group policies
    "Backups/**",          # System backups
]
```

**Decision Points:**
- If Groups.xml found → Decrypt cpassword (gpp-decrypt)
- If .vhd found → Mount and extract SAM/SYSTEM
- If domain info obtained → Proceed to Kerberos attacks

### 2.2 Kerberos Attacks
```
MODULES: impacket/asreproast, impacket/kerberoast
TOOLS: kerbrute, GetNPUsers.py, GetUserSPNs.py, nxc
```

**Automation Steps:**
1. User enumeration via Kerbrute
2. AS-REP roasting (no creds needed)
3. Kerberoasting (needs valid creds)
4. Crack obtained hashes

**Commands:**
```bash
# AS-REP Roasting (Forest, Intelligence)
nxc ldap $TARGET -u users.txt -p '' --asreproast asrep.out

# Kerberoasting (Active)
nxc ldap $TARGET -u $USER -p $PASS --kerberoasting kerb.out
```

---

## Phase 3: Web Application Enumeration

### 3.1 Initial Web Recon
```
MODULES: web/feroxbuster, web/httpx, web/wfuzz
TOOLS: feroxbuster, gobuster, dirsearch, wfuzz
```

**Automation Steps:**
1. Identify technology stack (httpx, whatweb)
2. Directory/file brute force
3. Subdomain enumeration
4. Virtual host enumeration

**Technology Detection Triggers:**
```python
TECH_EXPLOITS = {
    "drupal": ["drupalgeddon", "CVE-2018-7600"],
    "wordpress": ["wpscan", "plugin_vulns"],
    "strapi": ["CVE-2019-18818", "CVE-2019-19609"],
    "laravel": ["CVE-2021-3129"],
    "php_dev": ["backdoor_check"],  # PHP 8.1.0-dev (Knife)
}
```

### 3.2 Vulnerability Scanning
```
MODULES: web/sqlmap, web/wfuzz
TOOLS: sqlmap, nuclei, nikto
```

**Common Vulnerabilities:**
1. **SQL Injection** (Writer, Previse)
   - Test login forms
   - Test URL parameters

2. **Command Injection** (Previse)
   - Test input fields
   - Check for eval/system calls

3. **LFI/Directory Traversal** (Backdoor, Trick)
   - Test file inclusion parameters
   - php://filter wrapper

4. **SSTI** (Template Injection)
   - Test user-controlled output

---

## Phase 4: Initial Access

### 4.1 Credential Attacks
```
MODULES: network/nxc_smb, network/nxc_winrm, network/nxc_ssh
TOOLS: nxc, hydra, medusa
```

**Password Spray Strategy:**
1. Collect usernames from enumeration
2. Try common passwords
3. Try cracked hashes
4. Try password variations

### 4.2 Exploitation
```
MODULES: impacket/psexec, impacket/wmiexec, deploy/script
TOOLS: psexec.py, wmiexec.py, evil-winrm
```

**Access Methods by Protocol:**
```python
ACCESS_METHODS = {
    "smb": ["psexec", "smbexec", "wmiexec"],
    "winrm": ["evil-winrm"],
    "ssh": ["ssh"],
    "rdp": ["xfreerdp", "rdesktop"],
}
```

---

## Phase 5: Post-Exploitation

### 5.1 Local Enumeration
```
MODULES: deploy/script (linpeas, winpeas)
TOOLS: linpeas.sh, winpeas.exe, PowerUp
```

**Linux Privesc Checks:**
```python
LINUX_PRIVESC_CHECKS = [
    "suid_binaries",           # Cap
    "capabilities",            # Cap (python3.8 cap_setuid)
    "sudo_permissions",        # Armageddon, Previse, Knife
    "cron_jobs",
    "writable_paths",
    "kernel_exploits",         # Backdoor (CVE-2021-4034)
    "service_configs",
    "ssh_keys",
    "password_files",
]
```

**Windows Privesc Checks:**
```python
WINDOWS_PRIVESC_CHECKS = [
    "token_privs",
    "service_permissions",
    "registry_autoruns",
    "scheduled_tasks",
    "unquoted_paths",
    "always_install_elevated",
    "credential_files",        # mRemoteNG (Bastion)
    "kerberos_tickets",
]
```

### 5.2 Credential Harvesting
```
MODULES: impacket/secretsdump
TOOLS: secretsdump.py, mimikatz, pypykatz
```

**Locations to Check:**
- SAM/SYSTEM/SECURITY hives
- LSASS dump
- Browser credentials
- Application config files
- Database credentials

---

## Phase 6: Lateral Movement

### 6.1 AD Attacks
```
MODULES: impacket/secretsdump, impacket/psexec
TOOLS: bloodhound, secretsdump.py
```

**Attack Paths (Forest Example):**
1. Identify group memberships
2. Check for DCSync rights
3. Add user to privileged group
4. Grant DCSync permission
5. Dump domain hashes

### 6.2 Pivoting
```
MODULES: deploy/ligolo, c2/ligolo_pivot
TOOLS: ligolo-ng, chisel, ssh
```

---

## Automation Decision Tree

```
START
  │
  ├─► Port Scan
  │     │
  │     ├─► SMB (445) ──────► Null Session Enum
  │     │                         │
  │     │                         ├─► Shares Accessible ──► Spider & Download
  │     │                         │
  │     │                         └─► Domain Info ──► Kerberos Attacks
  │     │
  │     ├─► HTTP (80/443) ──► Tech Detection
  │     │                         │
  │     │                         ├─► Known CMS ──► CVE Check
  │     │                         │
  │     │                         └─► Directory Enum ──► Vuln Scan
  │     │
  │     ├─► LDAP (389) ─────► Anonymous Bind
  │     │                         │
  │     │                         └─► User Enum ──► AS-REP Roast
  │     │
  │     └─► Other Services ──► Service-Specific Enum
  │
  ├─► Credentials Obtained?
  │     │
  │     ├─► Yes ──► Test All Services
  │     │            │
  │     │            ├─► WinRM ──► Evil-WinRM
  │     │            ├─► SMB ──► PSExec/WMIExec
  │     │            └─► SSH ──► SSH Login
  │     │
  │     └─► No ──► Continue Enumeration
  │
  ├─► Initial Access Gained?
  │     │
  │     ├─► Yes ──► Deploy Enumeration Scripts
  │     │            │
  │     │            ├─► Linux ──► LinPEAS
  │     │            └─► Windows ──► WinPEAS
  │     │
  │     └─► No ──► Try Alternative Vectors
  │
  └─► Privilege Escalation
        │
        ├─► SUID/Capabilities (Linux)
        ├─► Sudo Misconfig (Linux)
        ├─► Kernel Exploit (Linux)
        ├─► Service Abuse (Windows)
        ├─► Token Manipulation (Windows)
        └─► AD Attack Paths (Windows)
```

---

## MCP Server Integration

### Automated Workflow States

```python
WORKFLOW_STATES = {
    "INIT": "Starting reconnaissance",
    "RECON_NETWORK": "Performing network discovery",
    "RECON_SERVICES": "Enumerating services",
    "ENUM_SMB": "SMB enumeration",
    "ENUM_WEB": "Web enumeration",
    "ENUM_AD": "Active Directory enumeration",
    "ATTACK_KERBEROS": "Kerberos attacks",
    "ATTACK_WEB": "Web exploitation",
    "INITIAL_ACCESS": "Gaining initial access",
    "POST_EXPLOIT": "Post-exploitation enumeration",
    "PRIV_ESC": "Privilege escalation",
    "LATERAL": "Lateral movement",
    "COMPLETE": "Assessment complete",
}
```

### Module Mapping

```python
PHASE_MODULES = {
    "RECON_NETWORK": [
        "recon/nmap_fast",
        "recon/nmap_comprehensive",
        "recon/nmap_udp",
    ],
    "ENUM_SMB": [
        "smb/enumeration",
        "smb/shares",
        "network/nxc_smb",
    ],
    "ENUM_WEB": [
        "web/httpx",
        "web/feroxbuster",
        "web/wfuzz",
    ],
    "ENUM_AD": [
        "network/nxc_ldap",
        "impacket/asreproast",
    ],
    "ATTACK_KERBEROS": [
        "impacket/asreproast",
        "impacket/kerberoast",
    ],
    "ATTACK_WEB": [
        "web/sqlmap",
    ],
    "INITIAL_ACCESS": [
        "network/nxc_smb",
        "network/nxc_winrm",
        "network/nxc_ssh",
        "impacket/psexec",
        "impacket/wmiexec",
    ],
    "POST_EXPLOIT": [
        "deploy/script",  # linpeas/winpeas
    ],
    "PRIV_ESC": [
        "impacket/secretsdump",
    ],
}
```

### AI Decision Prompts

```python
AI_DECISION_PROMPTS = {
    "analyze_ports": """
        Given these open ports and services: {services}
        What should be the priority enumeration order?
        Consider: {context}
    """,

    "analyze_smb_shares": """
        Found these SMB shares with access: {shares}
        Files found: {files}
        What sensitive data should we prioritize?
    """,

    "suggest_exploitation": """
        Target info:
        - Services: {services}
        - Vulnerabilities found: {vulns}
        - Credentials available: {creds}

        What exploitation path is most likely to succeed?
    """,

    "analyze_privesc": """
        System info:
        - OS: {os}
        - User context: {user}
        - Interesting findings: {findings}

        What privilege escalation vectors are available?
    """,
}
```

---

## Coverage Analysis

### Fully Supported in PurpleSploit

| Capability | Module(s) | HTB Example |
|------------|-----------|-------------|
| Nmap scanning (multiple profiles) | `recon/nmap*` | All |
| SMB enumeration and shares | `smb/*`, `network/nxc_smb` | Active, Bastion, Timelapse |
| NXC protocols (SMB, LDAP, WinRM, SSH, RDP, MSSQL) | `network/nxc_*` | Forest, Support |
| Kerberoasting / AS-REP Roasting | `impacket/kerberoast`, `impacket/asreproast` | Active, Forest |
| PSExec / WMIExec | `impacket/psexec`, `impacket/wmiexec` | Forest |
| Secrets Dump (DCSync) | `impacket/secretsdump` | Forest |
| Web directory fuzzing | `web/feroxbuster`, `web/wfuzz` | Armageddon, Backdoor |
| Subdomain/vhost fuzzing | `web/wfuzz` (vhost mode) | Horizontall, Trick |
| SQL injection | `web/sqlmap` | Writer, Previse |
| Script deployment (linpeas, winpeas) | `deploy/script` | Cap, Backdoor |
| Ligolo pivoting | `deploy/ligolo`, `c2/ligolo_pivot` | - |
| BloodHound data collection | `network/nxc_smb --bloodhound` | Forest |
| DNS zone transfer | `recon/dns` | Trick |
| Kerberos user enumeration | `ad/kerbrute` | Forest, Intelligence |
| WordPress scanning | `web/wpscan` | Backdoor |

### External Tool Dependencies

These capabilities require external tools to be installed:

| Capability | Tool | Install Command |
|------------|------|-----------------|
| GPP password decryption | `gpp-decrypt` | `apt install gpp-decrypt` |
| Hash cracking | `hashcat` / `john` | `apt install hashcat john` |
| VHD mounting | `guestmount` | `apt install libguestfs-tools` |
| BloodHound collection | `bloodhound-python` | `pip install bloodhound` |
| Nuclei scanning | `nuclei` | `go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest` |

### NXC Module Capabilities Reference

The `nxc` (NetExec) tool provides extensive functionality:

```bash
# BloodHound collection
nxc smb $TARGET -u $USER -p $PASS --bloodhound -c All

# GPP passwords (auto-decrypted)
nxc smb $TARGET -u $USER -p $PASS -M gpp_password

# Credential spraying
nxc smb $TARGET -u users.txt -p 'Password123'

# NTDS dump (DCSync alternative)
nxc smb $TARGET -u $USER -p $PASS --ntds
```

---

## Usage Example

```python
# MCP Server automation workflow
from purplesploit.modules.ai import PentestMethodology

methodology = PentestMethodology()

# Start automated assessment
methodology.start_assessment(target="10.10.10.100")

# The methodology will:
# 1. Run nmap scan
# 2. Detect services and branch appropriately
# 3. Run SMB enumeration if port 445 open
# 4. Run web enumeration if HTTP ports open
# 5. Attempt Kerberos attacks if AD detected
# 6. Try credentials across all available services
# 7. Deploy post-exploitation scripts on access
# 8. Suggest privilege escalation paths
```
