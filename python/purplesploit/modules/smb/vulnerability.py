"""
SMB Vulnerability Module

Scan for SMB vulnerabilities and exploits including EternalBlue, Zerologon, etc.
"""

from purplesploit.core.module import ExternalToolModule
from typing import Dict, Any, List


class SMBVulnerabilityModule(ExternalToolModule):
    """SMB vulnerability scanning operations."""

    def __init__(self, framework):
        super().__init__(framework)
        self.tool_name = "nxc"

    @property
    def name(self) -> str:
        return "SMB Vulnerability"

    @property
    def description(self) -> str:
        return "SMB vulnerability scanning and exploitation"

    @property
    def author(self) -> str:
        return "PurpleSploit Team"

    @property
    def category(self) -> str:
        return "smb"

    def _init_options(self):
        """Initialize module-specific options."""
        super()._init_options()

        self.options.update({
            "RHOST": {
                "value": None,
                "required": True,
                "description": "Target host IP address or hostname",
                "default": None
            },
            "USERNAME": {
                "value": None,
                "required": False,
                "description": "Username for authentication",
                "default": None
            },
            "PASSWORD": {
                "value": None,
                "required": False,
                "description": "Password for authentication",
                "default": None
            },
            "DOMAIN": {
                "value": None,
                "required": False,
                "description": "Domain name",
                "default": "WORKGROUP"
            },
        })

    def get_operations(self) -> List[Dict[str, Any]]:
        """Get list of vulnerability checking operations."""
        return [
            {"name": "MS17-010 (EternalBlue)", "description": "Check for EternalBlue vulnerability", "handler": "op_ms17_010"},
            {"name": "Zerologon (CVE-2020-1472)", "description": "Check for Zerologon vulnerability", "handler": "op_zerologon"},
            {"name": "PetitPotam", "description": "Check for PetitPotam vulnerability", "handler": "op_petitpotam"},
            {"name": "NoPac (CVE-2021-42278)", "description": "Check for NoPac vulnerability", "handler": "op_nopac"},
            {"name": "SMBGhost (CVE-2020-0796)", "description": "Check for SMBGhost vulnerability", "handler": "op_smbghost"},
            {"name": "PrintNightmare", "description": "Check for PrintNightmare vulnerability", "handler": "op_printnightmare"},
            {"name": "All Vulnerability Checks", "description": "Run all vulnerability checks", "handler": "op_all_vulns"},
        ]

    def _build_auth(self) -> str:
        """Build authentication string for nxc."""
        username = self.get_option("USERNAME")
        password = self.get_option("PASSWORD")

        if not username:
            return ""

        auth = f"-u '{username}'"
        if password:
            auth += f" -p '{password}'"
        else:
            auth += " -p ''"

        return auth

    def _execute_nxc(self, extra_args: str = "") -> Dict[str, Any]:
        """Execute nxc smb command."""
        rhost = self.get_option("RHOST")
        domain = self.get_option("DOMAIN")
        auth = self._build_auth()

        cmd = f"nxc smb {rhost} {auth}"

        if domain and domain != "WORKGROUP":
            cmd += f" -d {domain}"

        if extra_args:
            cmd += f" {extra_args}"

        return self.execute_command(cmd, timeout=300)

    def op_ms17_010(self) -> Dict[str, Any]:
        """Check for MS17-010 (EternalBlue)."""
        self.log("Checking for MS17-010 (EternalBlue) vulnerability", "info")
        # MS17-010 doesn't require auth
        rhost = self.get_option("RHOST")
        return self.execute_command(f"nxc smb {rhost} -M ms17-010")

    def op_zerologon(self) -> Dict[str, Any]:
        """Check for Zerologon vulnerability."""
        self.log("Checking for Zerologon (CVE-2020-1472)", "warning")
        return self._execute_nxc("-M zerologon")

    def op_petitpotam(self) -> Dict[str, Any]:
        """Check for PetitPotam vulnerability."""
        return self._execute_nxc("-M petitpotam")

    def op_nopac(self) -> Dict[str, Any]:
        """Check for NoPac vulnerability."""
        return self._execute_nxc("-M nopac")

    def op_smbghost(self) -> Dict[str, Any]:
        """Check for SMBGhost vulnerability."""
        self.log("Checking for SMBGhost (CVE-2020-0796)", "info")
        rhost = self.get_option("RHOST")
        return self.execute_command(f"nxc smb {rhost} -M smbghost")

    def op_printnightmare(self) -> Dict[str, Any]:
        """Check for PrintNightmare vulnerability."""
        return self._execute_nxc("-M printnightmare")

    def op_all_vulns(self) -> Dict[str, Any]:
        """Run all vulnerability checks."""
        self.log("Running all vulnerability checks...", "info")
        rhost = self.get_option("RHOST")
        auth = self._build_auth()

        results = []
        vulns = ["ms17-010", "smbghost"]  # No auth required
        auth_vulns = ["zerologon", "petitpotam", "nopac", "printnightmare"]  # Auth required

        # Run non-auth checks
        for vuln in vulns:
            self.log(f"Checking {vuln}...", "info")
            result = self.execute_command(f"nxc smb {rhost} -M {vuln}")
            results.append({vuln: result})

        # Run auth-required checks
        if auth:
            for vuln in auth_vulns:
                self.log(f"Checking {vuln}...", "info")
                result = self.execute_command(f"nxc smb {rhost} {auth} -M {vuln}")
                results.append({vuln: result})

        return {
            "success": True,
            "output": "Vulnerability scan complete",
            "results": results
        }

    def run(self) -> Dict[str, Any]:
        """Default run - check MS17-010."""
        return self.op_ms17_010()
