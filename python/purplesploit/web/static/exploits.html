<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exploits Browser - PurpleSploit</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1>ðŸ”® PurpleSploit</h1>
            <span class="version">v2.0.0</span>
        </div>
        <ul class="nav-menu">
            <li><a href="/">Dashboard</a></li>
            <li><a href="/static/targets.html">Targets</a></li>
            <li><a href="/static/exploits.html" class="active">Exploits</a></li>
            <li><a href="/api/docs" target="_blank">API Docs</a></li>
        </ul>
    </nav>

    <div class="container">
        <header class="page-header">
            <h2>Exploits Browser</h2>
            <p class="subtitle">All discovered exploits from searchsploit analysis</p>
        </header>

        <div class="section">
            <div class="card">
                <div class="filter-bar">
                    <input type="text" id="search-input" placeholder="Search exploits..." class="search-input">
                    <select id="target-filter" class="filter-select">
                        <option value="">All Targets</option>
                    </select>
                    <select id="service-filter" class="filter-select">
                        <option value="">All Services</option>
                    </select>
                    <select id="platform-filter" class="filter-select">
                        <option value="">All Platforms</option>
                    </select>
                </div>

                <div class="stats-bar">
                    <div class="stat-item">
                        <span class="stat-label">Total Exploits:</span>
                        <span class="stat-value" id="total-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Filtered:</span>
                        <span class="stat-value" id="filtered-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Targets Affected:</span>
                        <span class="stat-value" id="targets-count">0</span>
                    </div>
                </div>

                <div id="exploits-container">
                    <div class="loading">Loading exploits...</div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 PurpleSploit - Pentesting Framework</p>
    </footer>

    <script src="/static/js/app.js"></script>
    <script>
        let allExploits = [];

        document.addEventListener('DOMContentLoaded', async function() {
            await loadExploits();

            // Setup filters
            document.getElementById('search-input').addEventListener('input', filterExploits);
            document.getElementById('target-filter').addEventListener('change', filterExploits);
            document.getElementById('service-filter').addEventListener('change', filterExploits);
            document.getElementById('platform-filter').addEventListener('change', filterExploits);
        });

        async function loadExploits() {
            try {
                const exploits = await API.getExploits();
                allExploits = exploits;

                // Populate filters
                populateFilters(exploits);

                // Display exploits
                displayExploits(exploits);

                // Update stats
                updateStats(exploits, exploits);
            } catch (error) {
                console.error('Error loading exploits:', error);
                document.getElementById('exploits-container').innerHTML =
                    '<div class="error">Failed to load exploits. Make sure the API server is running.</div>';
            }
        }

        function populateFilters(exploits) {
            // Populate targets
            const targets = new Set(exploits.map(e => e.target));
            const targetFilter = document.getElementById('target-filter');
            Array.from(targets).sort().forEach(target => {
                const option = document.createElement('option');
                option.value = target;
                option.textContent = target;
                targetFilter.appendChild(option);
            });

            // Populate services
            const services = new Set(exploits.map(e => e.service));
            const serviceFilter = document.getElementById('service-filter');
            Array.from(services).sort().forEach(service => {
                const option = document.createElement('option');
                option.value = service;
                option.textContent = service.toUpperCase();
                serviceFilter.appendChild(option);
            });

            // Populate platforms
            const platforms = new Set(exploits.filter(e => e.platform).map(e => e.platform));
            const platformFilter = document.getElementById('platform-filter');
            Array.from(platforms).sort().forEach(platform => {
                const option = document.createElement('option');
                option.value = platform;
                option.textContent = platform;
                platformFilter.appendChild(option);
            });
        }

        function filterExploits() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const targetFilter = document.getElementById('target-filter').value;
            const serviceFilter = document.getElementById('service-filter').value;
            const platformFilter = document.getElementById('platform-filter').value;

            const filtered = allExploits.filter(exploit => {
                const matchesSearch = exploit.exploit_title.toLowerCase().includes(searchTerm) ||
                                     (exploit.exploit_path && exploit.exploit_path.toLowerCase().includes(searchTerm)) ||
                                     (exploit.version && exploit.version.toLowerCase().includes(searchTerm));

                const matchesTarget = !targetFilter || exploit.target === targetFilter;
                const matchesService = !serviceFilter || exploit.service === serviceFilter;
                const matchesPlatform = !platformFilter || exploit.platform === platformFilter;

                return matchesSearch && matchesTarget && matchesService && matchesPlatform;
            });

            displayExploits(filtered);
            updateStats(allExploits, filtered);
        }

        function updateStats(all, filtered) {
            document.getElementById('total-count').textContent = all.length;
            document.getElementById('filtered-count').textContent = filtered.length;

            const affectedTargets = new Set(filtered.map(e => e.target)).size;
            document.getElementById('targets-count').textContent = affectedTargets;
        }

        function displayExploits(exploits) {
            const container = document.getElementById('exploits-container');

            if (exploits.length === 0) {
                container.innerHTML = '<div class="empty">No exploits found matching your criteria</div>';
                return;
            }

            // Group by target
            const grouped = {};
            exploits.forEach(exploit => {
                if (!grouped[exploit.target]) {
                    grouped[exploit.target] = [];
                }
                grouped[exploit.target].push(exploit);
            });

            container.innerHTML = Object.entries(grouped).map(([target, targetExploits]) => `
                <div class="exploit-group">
                    <div class="group-header">
                        <h3>
                            <span class="target-name">${target}</span>
                            <span class="badge badge-info">${targetExploits.length} exploit${targetExploits.length > 1 ? 's' : ''}</span>
                        </h3>
                        <a href="/static/target.html?ip=${target}" class="btn btn-sm btn-secondary">View Target</a>
                    </div>

                    <div class="exploits-list">
                        ${targetExploits.map(exploit => `
                        <div class="exploit-card">
                            <div class="exploit-header">
                                <h4>${exploit.exploit_title}</h4>
                                <div class="exploit-badges">
                                    ${exploit.edb_id ? `<span class="badge badge-info">EDB-${exploit.edb_id}</span>` : ''}
                                    ${exploit.platform ? `<span class="badge badge-secondary">${exploit.platform}</span>` : ''}
                                    ${exploit.exploit_type ? `<span class="badge badge-secondary">${exploit.exploit_type}</span>` : ''}
                                </div>
                            </div>

                            <div class="exploit-details">
                                <div class="detail-row">
                                    <span class="detail-label">Service:</span>
                                    <span class="detail-value"><strong>${exploit.service}:${exploit.port}</strong></span>
                                </div>
                                ${exploit.version ? `
                                <div class="detail-row">
                                    <span class="detail-label">Version:</span>
                                    <span class="detail-value"><code>${exploit.version}</code></span>
                                </div>
                                ` : ''}
                                ${exploit.exploit_path ? `
                                <div class="detail-row">
                                    <span class="detail-label">Path:</span>
                                    <span class="detail-value"><code class="exploit-path">${exploit.exploit_path}</code></span>
                                </div>
                                ` : ''}
                                ${exploit.created_at ? `
                                <div class="detail-row">
                                    <span class="detail-label">Discovered:</span>
                                    <span class="detail-value">${new Date(exploit.created_at).toLocaleString()}</span>
                                </div>
                                ` : ''}
                            </div>

                            ${exploit.edb_id ? `
                            <div class="exploit-actions">
                                <a href="https://www.exploit-db.com/exploits/${exploit.edb_id}" target="_blank" class="btn btn-sm btn-primary">
                                    View on Exploit-DB â†’
                                </a>
                                ${exploit.exploit_path ? `
                                <button class="btn btn-sm btn-secondary" onclick="copyPath('${exploit.exploit_path}')">
                                    Copy Path
                                </button>
                                ` : ''}
                            </div>
                            ` : ''}
                        </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function copyPath(path) {
            navigator.clipboard.writeText(path).then(() => {
                // Show toast or notification
                alert('Path copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
    </script>
</body>
</html>
